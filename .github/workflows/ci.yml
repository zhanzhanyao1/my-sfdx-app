name: Salesforce CI

on:
  pull_request:
    branches:
      - main

jobs:
  validate_and_test:
    runs-on: ubuntu-latest
    environment: Dev  # 使用 Environment 绑定 secret

    steps:
      # 1️⃣ 检出代码
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ 设置 Salesforce env variables
      - name: Set Salesforce env variables
        run: |
          echo "SF_USERNAME=${{ secrets.SF_USERNAME }}" >> $GITHUB_ENV
          echo "SF_CLIENT_ID=${{ secrets.SF_CLIENT_ID }}" >> $GITHUB_ENV
          echo "SF_JWT_KEY<<EOF" >> $GITHUB_ENV
          echo "${{ secrets.SF_JWT_KEY }}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "SF_LOGIN_URL=${{ secrets.SF_LOGIN_URL }}" >> $GITHUB_ENV

      # 3️⃣ 安装 Salesforce CLI
      - name: Install Salesforce CLI
        run: |
          npm install sfdx-cli --global

      # 4️⃣ JWT 登录 Salesforce
      - name: Authenticate to Salesforce using JWT
        run: |
          echo "${SF_JWT_KEY}" > server.key
          chmod 600 server.key
          sfdx auth:jwt:grant \
            --clientid $SF_C_
