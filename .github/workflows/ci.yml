
name: Salesforce CI

on:
  pull_request:
    branches:
      - develop
      - staging
      - main

jobs:
  validate_and_test:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ ç¼“å­˜ä¾èµ–ï¼Œæé«˜ CI æ‰§è¡Œæ•ˆç‡
      - name: Cache NPM dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      # 2ï¸âƒ£ æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v3

      # 3ï¸âƒ£ è®¾ç½® Salesforce ç¯å¢ƒå˜é‡
      - name: Set Salesforce env variables
        id: set-env
        run: |
          if [[ "${{ github.head_ref }}" == "develop" ]]; then
            echo "SF_ENV=QA" >> $GITHUB_ENV
            echo "SF_USERNAME=${{ secrets.QA_SF_USERNAME }}" >> $GITHUB_ENV
            echo "SF_CLIENT_ID=${{ secrets.QA_SF_CLIENT_ID }}" >> $GITHUB_ENV
            echo "SF_JWT_KEY<<EOF" >> $GITHUB_ENV
            echo "${{ secrets.QA_SF_JWT_KEY }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            echo "SF_LOGIN_URL=${{ secrets.QA_SF_LOGIN_URL }}" >> $GITHUB_ENV
          elif [[ "${{ github.head_ref }}" == "staging" ]]; then
            echo "SF_ENV=STAGING" >> $GITHUB_ENV
            echo "SF_USERNAME=${{ secrets.STAGING_SF_USERNAME }}" >> $GITHUB_ENV
            echo "SF_CLIENT_ID=${{ secrets.STAGING_SF_CLIENT_ID }}" >> $GITHUB_ENV
            echo "SF_JWT_KEY<<EOF" >> $GITHUB_ENV
            echo "${{ secrets.STAGING_SF_JWT_KEY }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            echo "SF_LOGIN_URL=${{ secrets.STAGING_SF_LOGIN_URL }}" >> $GITHUB_ENV
          elif [[ "${{ github.head_ref }}" == "master" ]]; then
            echo "SF_ENV=PROD" >> $GITHUB_ENV
            echo "SF_USERNAME=${{ secrets.PROD_SF_USERNAME }}" >> $GITHUB_ENV
            echo "SF_CLIENT_ID=${{ secrets.PROD_SF_CLIENT_ID }}" >> $GITHUB_ENV
            echo "SF_JWT_KEY<<EOF" >> $GITHUB_ENV
            echo "${{ secrets.PROD_SF_JWT_KEY }}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            echo "SF_LOGIN_URL=${{ secrets.PROD_SF_LOGIN_URL }}" >> $GITHUB_ENV
          else
            echo "Branch not supported for CI"
            exit 1
          fi

      # 4ï¸âƒ£ å®‰è£… Salesforce CLI
      - name: Setup Salesforce CLI
        uses: amtrack/sfdx-action@v1
        with:
          version: latest

      # 5ï¸âƒ£ JWT ç™»å½• Salesforce
      - name: Authenticate to Salesforce using JWT
        run: |
          echo "${SF_JWT_KEY}" > server.key
          chmod 600 server.key
          sfdx auth:jwt:grant --clientid $SF_CLIENT_ID --jwtkeyfile server.key --username $SF_USERNAME --setdefaultusername --instanceurl $SF_LOGIN_URL

      # 6ï¸âƒ£ éªŒè¯éƒ¨ç½²ï¼ˆcheck-onlyï¼‰
      - name: Validate deployment (check-only)
        run: |
          sfdx force:source:deploy -p force-app/main/default -w 10 --checkonly

      # 7ï¸âƒ£ è¿è¡Œ Apex æµ‹è¯•å¹¶å¯¼å‡ºç»“æœï¼ˆJUnit + JSONï¼‰
      - name: Run Apex tests
        run: |
          mkdir -p test-results coverage
          sfdx force:apex:test:run --wait 10 --resultformat junit --codecoverage --testlevel RunLocalTests --outputdir test-results
          sfdx force:apex:test:report --wait 10 --resultformat json --codecoverage --outputdir coverage

      # 8ï¸âƒ£ PMD é™æ€æ‰«æ
      - name: Run PMD static code analysis
        run: |
          npm install -g pmd-bin
          pmd-bin run --dir force-app --rulesets apex-rules.xml --reportfile pmd-report.xml

      # 9ï¸âƒ£ æ‰“åŒ… Salesforce metadata
      - name: Convert and Package Salesforce Metadata
        run: |
          mkdir -p deploy-package
          sfdx force:source:convert -r force-app -d deploy-package
          zip -r deploy-package.zip deploy-package

      # ğŸ”Ÿ ä¸Šä¼ æ„å»ºç»“æœ artifactï¼ˆæµ‹è¯• + è¦†ç›–ç‡ + PMD + metadata packageï¼‰
      - name: Upload Build Artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: salesforce-ci-artifacts-${{ env.SF_ENV }}
          path: |
            test-results/
            coverage/
            pmd-report.xml
            deploy-package.zip

      # 1ï¸âƒ£1ï¸âƒ£ SonarQube æ‰«æï¼ˆè´¨é‡é—¨æ§ï¼‰
      - name: Run SonarQube Scan
        uses: sonarsource/sonarcloud-github-action@v2
        with:
          projectKey: ${{ secrets.SONAR_PROJECT_KEY }}
          organization: ${{ secrets.SONAR_ORG }}
          token: ${{ secrets.SONAR_TOKEN }}
          extraProperties: |
            sonar.sources=force-app
            sonar.tests=force-app
            sonar.test.inclusions=**/*Test.cls
            sonar.language=apex
            sonar.junit.reportPaths=test-results/**/*.xml
            sonar.javascript.lcov.reportPaths=coverage/lcov.info
            sonar.qualitygate.wait=true
